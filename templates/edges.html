{% extends "base.html" %}

{% block title %}Edges - AGE Graph Manager{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-md-12">
        <!-- Graph selector -->
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <label for="graphSelectorEdges" class="form-label mb-0"><strong>Select Graph:</strong></label>
                        <select class="form-select" id="graphSelectorEdges">
                            <option value="">-- Select a graph --</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-primary mt-4" id="loadGraphBtnEdges">Load Graph</button>
                        <span id="currentGraphDisplay" class="ms-3 text-muted"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <h2>Create Edge</h2>
        <form id="edgeForm">
            <div class="mb-3">
                <label for="fromNode" class="form-label">From Node *</label>
                <select class="form-select" id="fromNode" required>
                    <option value="">-- Select source node --</option>
                </select>
                <small class="form-text text-muted">Select the source node for the relationship</small>
            </div>
            
            <div class="mb-3">
                <label for="toNode" class="form-label">To Node *</label>
                <select class="form-select" id="toNode" required>
                    <option value="">-- Select target node --</option>
                </select>
                <small class="form-text text-muted">Select the target node for the relationship</small>
            </div>
            
            <div class="mb-3">
                <label for="edgeLabel" class="form-label">Edge Label *</label>
                <input type="text" class="form-control" id="edgeLabel" required placeholder="e.g., KNOWS, PURCHASED, LOCATED_IN">
                <small class="form-text text-muted">The type of relationship</small>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Properties (Optional)</label>
                <div id="edgePropertiesContainer">
                    <div class="row mb-2 property-row">
                        <div class="col-5">
                            <input type="text" class="form-control property-key" placeholder="Key (e.g., since)">
                        </div>
                        <div class="col-5">
                            <input type="text" class="form-control property-value" placeholder="Value">
                        </div>
                        <div class="col-2">
                            <button type="button" class="btn btn-sm btn-danger remove-property">Remove</button>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-secondary" id="addEdgeProperty">Add Property</button>
            </div>
            
            <button type="submit" class="btn btn-primary">Create Edge</button>
        </form>
        
        <div id="edgeResult" class="mt-3"></div>
    </div>
    
    <div class="col-md-6">
        <h2>Existing Edges</h2>
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="edgeLabelFilter" class="form-label">Filter by Label:</label>
                <select class="form-select" id="edgeLabelFilter">
                    <option value="">All Labels</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-secondary w-100" id="applyEdgeFilter">Apply Filter</button>
            </div>
        </div>
        <div id="edgesList" class="list-group">
            <p class="text-muted">Loading edges...</p>
        </div>
        <nav aria-label="Edges pagination" class="mt-3">
            <ul class="pagination justify-content-center" id="edgesPagination">
            </ul>
        </nav>
        <div class="text-center text-muted small" id="edgesCount"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Declare functions in outer scope
async function loadGraphsList() {
    try {
        const response = await fetch('/api/graphs');
        const result = await response.json();
        const selector = document.getElementById('graphSelectorEdges');
        
        if (result.error) {
            selector.innerHTML = '<option value="">Error loading graphs</option>';
        } else if (result.graphs && result.graphs.length > 0) {
            const options = '<option value="">-- Select a graph --</option>' +
                result.graphs.map(graph => 
                    `<option value="${graph}">${graph}</option>`
                ).join('');
            selector.innerHTML = options;
            
            // Set current graph if available
            const currentGraph = '{{ current_graph }}';
            if (currentGraph && currentGraph !== 'None') {
                selector.value = currentGraph;
            }
        } else {
            selector.innerHTML = '<option value="">No graphs available</option>';
        }
    } catch (error) {
        console.error('Error loading graphs:', error);
    }
}

async function selectGraph(graphName) {
    try {
        const response = await fetch('/api/graphs/select', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ graph_name: graphName })
        });
        
        const result = await response.json();
        
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            document.getElementById('currentGraphDisplay').innerHTML = `<strong>Current: ${graphName}</strong>`;
            loadNodesForDropdowns();
            loadEdges();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Load nodes for dropdown selectors
async function loadNodesForDropdowns() {
    try {
        const response = await fetch('/api/nodes');
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.warn('No graph selected');
            return;
        }
        
        const result = await response.json();
        const fromNodeSelect = document.getElementById('fromNode');
        const toNodeSelect = document.getElementById('toNode');
        
        if (result.error) {
            fromNodeSelect.innerHTML = '<option value="">Error loading nodes</option>';
            toNodeSelect.innerHTML = '<option value="">Error loading nodes</option>';
        } else if (result.result && result.result.length > 0) {
            const options = '<option value="">-- Select node --</option>' +
                result.result.map(node => {
                    try {
                        // Parse node data - remove AGE type annotation
                        const nodeStr = node[0].split('::')[0].trim();
                        const nodeData = JSON.parse(nodeStr);
                        const nodeId = nodeData.id;
                        const nodeLabel = nodeData.label || 'Node';
                        const nodeProperties = nodeData.properties || {};
                        const nodeName = nodeProperties.name || nodeProperties.title || `${nodeLabel} (ID: ${nodeId})`;
                        
                        return `<option value="${nodeId}">${nodeName} - ID: ${nodeId}</option>`;
                    } catch (e) {
                        console.error('Error parsing node:', e);
                        return '';
                    }
                }).join('');
            
            fromNodeSelect.innerHTML = options;
            toNodeSelect.innerHTML = options;
        } else {
            fromNodeSelect.innerHTML = '<option value="">No nodes available - create nodes first</option>';
            toNodeSelect.innerHTML = '<option value="">No nodes available - create nodes first</option>';
        }
    } catch (error) {
        console.error('Error loading nodes for dropdowns:', error);
    }
}

// Load edges with pagination
let allEdges = [];
let currentEdgePage = 1;
const edgesPerPage = 25;
let currentEdgeLabel = '';

async function loadEdges(label = null) {
    currentEdgeLabel = label || '';
    const url = label ? `/api/edges?label=${label}` : '/api/edges';
    try {
        const response = await fetch(url);
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            // Received HTML instead of JSON - likely redirected
            document.getElementById('edgesList').innerHTML = 
                `<p class="text-warning">No graph selected. Please select a graph from the <a href="/">home page</a>.</p>`;
            return;
        }
        
        const result = await response.json();
        
        if (result.error) {
            document.getElementById('edgesList').innerHTML = `<p class="text-danger">${result.error}</p>`;
            allEdges = [];
        } else if (result.result && result.result.length > 0) {
            allEdges = result.result;
            
            // Extract unique labels for filter
            const labels = new Set();
            allEdges.forEach(edge => {
                try {
                    const edgeStr = edge[1].split('::')[0].trim();
                    const edgeData = JSON.parse(edgeStr);
                    if (edgeData.label) labels.add(edgeData.label);
                } catch (e) {
                    console.error('Error parsing edge for label:', e);
                }
            });
            
            // Update label filter dropdown
            const labelFilter = document.getElementById('edgeLabelFilter');
            const currentValue = labelFilter.value;
            labelFilter.innerHTML = '<option value="">All Labels</option>' +
                Array.from(labels).sort().map(label => 
                    `<option value="${label}">${label}</option>`
                ).join('');
            labelFilter.value = currentValue;
            
            currentEdgePage = 1;
            displayEdgePage();
        } else {
            allEdges = [];
            document.getElementById('edgesList').innerHTML = '<p class="text-muted">No edges found</p>';
            document.getElementById('edgesPagination').innerHTML = '';
            document.getElementById('edgesCount').innerHTML = '';
        }
    } catch (error) {
        document.getElementById('edgesList').innerHTML = 
            `<p class="text-danger">Error loading edges: ${error.message}</p>`;
        allEdges = [];
    }
}

function displayEdgePage() {
    const edgesList = document.getElementById('edgesList');
    const start = (currentEdgePage - 1) * edgesPerPage;
    const end = start + edgesPerPage;
    const pageEdges = allEdges.slice(start, end);
    
    if (pageEdges.length === 0) {
        edgesList.innerHTML = '<p class="text-muted">No edges found</p>';
        return;
    }
    
    edgesList.innerHTML = pageEdges.map(edge => {
        try {
            // Parse edge data from AGE format - remove type annotations
            const fromStr = edge[0].split('::')[0].trim();
            const edgeStr = edge[1].split('::')[0].trim();
            const toStr = edge[2].split('::')[0].trim();
            
            const fromNode = JSON.parse(fromStr);
            const edgeData = JSON.parse(edgeStr);
            const toNode = JSON.parse(toStr);
            
            const fromLabel = fromNode.label || 'Node';
            const toLabel = toNode.label || 'Node';
            const edgeLabel = edgeData.label || 'CONNECTED';
            const edgeId = edgeData.id;
            const edgeProperties = edgeData.properties || {};
            
            return `<div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${fromLabel} (${fromNode.id})</strong> 
                        -[${edgeLabel}]-> 
                        <strong>${toLabel} (${toNode.id})</strong>
                        <div class="small text-muted">Edge ID: ${edgeId} | Properties: ${JSON.stringify(edgeProperties)}</div>
                    </div>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-primary" onclick="editEdge(${edgeId}, ${fromNode.id}, ${toNode.id}, '${edgeLabel}', ${JSON.stringify(edgeProperties).replace(/"/g, '&quot;')})">Edit</button>
                        <button class="btn btn-outline-danger" onclick="deleteEdge(${edgeId})">Delete</button>
                    </div>
                </div>
            </div>`;
        } catch (e) {
            console.error('Error parsing edge:', e);
            return `<div class="list-group-item list-group-item-danger">Error parsing edge</div>`;
        }
    }).join('');
    
    // Update pagination
    displayEdgePagination();
    
    // Update count
    document.getElementById('edgesCount').innerHTML = 
        `Showing ${start + 1}-${Math.min(end, allEdges.length)} of ${allEdges.length} edges`;
}

function displayEdgePagination() {
    const totalPages = Math.ceil(allEdges.length / edgesPerPage);
    const pagination = document.getElementById('edgesPagination');
    
    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    
    // Previous button
    html += `<li class="page-item ${currentEdgePage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changeEdgePage(${currentEdgePage - 1}); return false;">Previous</a>
    </li>`;
    
    // Page numbers
    const maxPages = 5;
    let startPage = Math.max(1, currentEdgePage - Math.floor(maxPages / 2));
    let endPage = Math.min(totalPages, startPage + maxPages - 1);
    
    if (endPage - startPage < maxPages - 1) {
        startPage = Math.max(1, endPage - maxPages + 1);
    }
    
    if (startPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="changeEdgePage(1); return false;">1</a></li>`;
        if (startPage > 2) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        html += `<li class="page-item ${i === currentEdgePage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="changeEdgePage(${i}); return false;">${i}</a>
        </li>`;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `<li class="page-item"><a class="page-link" href="#" onclick="changeEdgePage(${totalPages}); return false;">${totalPages}</a></li>`;
    }
    
    // Next button
    html += `<li class="page-item ${currentEdgePage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changeEdgePage(${currentEdgePage + 1}); return false;">Next</a>
    </li>`;
    
    pagination.innerHTML = html;
}

function changeEdgePage(page) {
    const totalPages = Math.ceil(allEdges.length / edgesPerPage);
    if (page < 1 || page > totalPages) return;
    currentEdgePage = page;
    displayEdgePage();
}

document.addEventListener('DOMContentLoaded', async function() {
    // Load available graphs first
    await loadGraphsList();
    
    // Check if a graph is already selected in session
    const currentGraph = '{{ current_graph }}';
    if (currentGraph && currentGraph !== 'None') {
        document.getElementById('graphSelectorEdges').value = currentGraph;
        document.getElementById('currentGraphDisplay').innerHTML = `<strong>Current: ${currentGraph}</strong>`;
        loadNodesForDropdowns();
        loadEdges();
    } else {
        document.getElementById('edgesList').innerHTML = '<p class="text-warning">Please select a graph above to view edges.</p>';
    }
    
    // Load graph button
    document.getElementById('loadGraphBtnEdges').addEventListener('click', function() {
        const selectedGraph = document.getElementById('graphSelectorEdges').value;
        if (selectedGraph) {
            selectGraph(selectedGraph);
        } else {
            alert('Please select a graph first');
        }
    });
    
    // Apply filter button
    document.getElementById('applyEdgeFilter').addEventListener('click', function() {
        const selectedLabel = document.getElementById('edgeLabelFilter').value;
        loadEdges(selectedLabel);
    });
    
    // Add property functionality
    document.getElementById('addEdgeProperty').addEventListener('click', function() {
        const container = document.getElementById('edgePropertiesContainer');
        const row = document.createElement('div');
        row.className = 'row mb-2 property-row';
        row.innerHTML = `
            <div class="col-5">
                <input type="text" class="form-control property-key" placeholder="Key">
            </div>
            <div class="col-5">
                <input type="text" class="form-control property-value" placeholder="Value">
            </div>
            <div class="col-2">
                <button type="button" class="btn btn-sm btn-danger remove-property">Remove</button>
            </div>
        `;
        container.appendChild(row);
    });
    
    // Remove property functionality
    document.getElementById('edgePropertiesContainer').addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-property')) {
            e.target.closest('.property-row').remove();
        }
    });
    
    // Submit form
    document.getElementById('edgeForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const form = e.target;
        const isUpdateMode = form.dataset.mode === 'update';
        const edgeId = form.dataset.edgeId;
        
        const from_node_id = parseInt(document.getElementById('fromNode').value);
        const to_node_id = parseInt(document.getElementById('toNode').value);
        const label = document.getElementById('edgeLabel').value;
        
        if (!from_node_id || !to_node_id) {
            alert('Please select both source and target nodes');
            return;
        }
        
        const properties = {};
        
        document.querySelectorAll('#edgePropertiesContainer .property-row').forEach(row => {
            const key = row.querySelector('.property-key').value.trim();
            const value = row.querySelector('.property-value').value.trim();
            if (key && value) {
                properties[key] = value;
            }
        });
        
        try {
            let response;
            if (isUpdateMode) {
                // Update existing edge
                response = await fetch(`/api/edges/${edgeId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ properties })
                });
            } else {
                // Create new edge
                response = await fetch('/api/edges', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ from_node_id, to_node_id, label, properties })
                });
            }
            
            const result = await response.json();
            const resultDiv = document.getElementById('edgeResult');
            
            if (result.error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">${result.error}</div>`;
            } else {
                const message = isUpdateMode ? 'Edge updated successfully!' : 'Edge created successfully!';
                resultDiv.innerHTML = `<div class="alert alert-success">${message}</div>`;
                
                if (isUpdateMode) {
                    cancelEditEdge();
                } else {
                    document.getElementById('edgeForm').reset();
                }
                
                loadEdges();
            }
        } catch (error) {
            document.getElementById('edgeResult').innerHTML = 
                `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    });
    
    // Filter edges
    document.getElementById('filterEdgeLabel').addEventListener('input', function(e) {
        const label = e.target.value.trim();
        loadEdges(label || null);
    });
    
    // Initial load
    loadEdges();
});

// Edit edge function
function editEdge(edgeId, fromNodeId, toNodeId, edgeLabel, properties) {
    // Populate the form with existing data
    document.getElementById('fromNode').value = fromNodeId;
    document.getElementById('toNode').value = toNodeId;
    document.getElementById('edgeLabel').value = edgeLabel;
    
    // Disable node selectors during edit
    document.getElementById('fromNode').disabled = true;
    document.getElementById('toNode').disabled = true;
    document.getElementById('edgeLabel').disabled = true;
    
    // Clear and populate properties
    const container = document.getElementById('edgePropertiesContainer');
    container.innerHTML = '';
    
    Object.entries(properties).forEach(([key, value]) => {
        const propertyRow = document.createElement('div');
        propertyRow.className = 'row mb-2 property-row';
        propertyRow.innerHTML = `
            <div class="col-5">
                <input type="text" class="form-control property-key" value="${key}" placeholder="Key">
            </div>
            <div class="col-5">
                <input type="text" class="form-control property-value" value="${value}" placeholder="Value">
            </div>
            <div class="col-2">
                <button type="button" class="btn btn-sm btn-danger remove-property">Remove</button>
            </div>
        `;
        container.appendChild(propertyRow);
    });
    
    // Change form to update mode
    const form = document.getElementById('edgeForm');
    form.dataset.mode = 'update';
    form.dataset.edgeId = edgeId;
    
    // Change button text
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Update Edge';
    submitBtn.className = 'btn btn-warning';
    
    // Add cancel button
    let cancelBtn = document.getElementById('cancelEditEdgeBtn');
    if (!cancelBtn) {
        cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.id = 'cancelEditEdgeBtn';
        cancelBtn.className = 'btn btn-secondary ms-2';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.onclick = cancelEditEdge;
        submitBtn.parentNode.appendChild(cancelBtn);
    }
    
    // Scroll to form
    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Cancel edit function
function cancelEditEdge() {
    const form = document.getElementById('edgeForm');
    form.reset();
    delete form.dataset.mode;
    delete form.dataset.edgeId;
    
    // Re-enable node selectors
    document.getElementById('fromNode').disabled = false;
    document.getElementById('toNode').disabled = false;
    document.getElementById('edgeLabel').disabled = false;
    
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = 'Create Edge';
    submitBtn.className = 'btn btn-primary';
    
    const cancelBtn = document.getElementById('cancelEditEdgeBtn');
    if (cancelBtn) {
        cancelBtn.remove();
    }
}

// Delete edge function
async function deleteEdge(edgeId) {
    if (!confirm(`Are you sure you want to delete edge ${edgeId}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/edges/${edgeId}`, {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'}
        });
        
        const result = await response.json();
        
        if (result.error) {
            alert('Error: ' + result.error);
        } else {
            alert('Edge deleted successfully!');
            loadEdges();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

</script>
{% endblock %}
